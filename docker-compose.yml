version: '3.8'
networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.32.44.0/22
services:
  lighter-data-collector:
    build: .
    container_name: lighter-collector
    restart: unless-stopped
    volumes:
      - ./lighter_data:/app/lighter_data
      - ./logs:/app/logs
      - ./params:/app/params
      - ./gather_lighter_data.py:/app/gather_lighter_data.py:ro
      - ./calculate_avellaneda_parameters.py:/app/calculate_avellaneda_parameters.py:ro
      - ./market_maker.py:/app/market_maker.py:ro
      - ./signer_client.py:/usr/local/lib/python3.11/site-packages/lighter/signer_client.py
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_DIR=/app/logs
    command: python gather_lighter_data.py

  avellaneda-calculator:
    build: .
    container_name: avellaneda-calculator
    restart: unless-stopped
    volumes:
      - ./lighter_data:/app/lighter_data:ro
      - ./logs:/app/logs
      - ./params:/app/params
      - ./calculate_avellaneda_parameters.py:/app/calculate_avellaneda_parameters.py:ro
      - ./signer_client.py:/usr/local/lib/python3.11/site-packages/lighter/signer_client.py
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - HL_DATA_LOC=/app/lighter_data
      - PARAMS_DIR=/app/params
      - LOG_DIR=/app/logs
      - INTERVAL_SECONDS=600
    command: >
      sh -c "
        while true; do
          echo 'Calculating Avellaneda parameters...';
          python calculate_avellaneda_parameters.py --ticker $$MARKET_SYMBOL --minutes 10;
          echo 'Sleeping before next run...';
          sleep $$INTERVAL_SECONDS;
        done
      "
    depends_on:
      - lighter-data-collector

  supertrend-calculator:
    build: .
    container_name: supertrend-calculator
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./params:/app/params
      - ./logs:/app/logs
      - ./find_trend_lighter.py:/app/find_trend_lighter.py:ro
      - ./signer_client.py:/usr/local/lib/python3.11/site-packages/lighter/signer_client.py
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - PARAMS_DIR=/app/params
      - LOG_DIR=/app/logs
    command: >
      sh -c "
        while true; do
          echo 'Running supertrend calculator...';
          python find_trend_lighter.py --symbol $$MARKET_SYMBOL --interval 5m;
          echo 'Sleeping for 2 minutes...';
          sleep 120;
        done
      "
    depends_on:
      - lighter-data-collector

  market-maker:
    build: .
    container_name: market-maker
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./params:/app/params:ro
      - ./logs:/app/logs
      - ./market_maker.py:/app/market_maker.py:ro
      - ./signer_client.py:/usr/local/lib/python3.11/site-packages/lighter/signer_client.py
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - PARAMS_DIR=/app/params
      - LOG_DIR=/app/logs
      - RESTART_SECONDS=60
    command: >
      sh -c "
        while true; do
          echo 'Starting market maker...';
          python market_maker.py --symbol $$MARKET_SYMBOL;
          sleep $$RESTART_SECONDS;
        done
      "
    depends_on:
      - avellaneda-calculator
